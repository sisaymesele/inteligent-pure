{% extends "dashboard.html" %}
{% load humanize %}

{% block content %}
<div class="container-fluid" id="full-page-container">

    <!-- Messages -->
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}

    {% if permissions.swot_report_view %}
        <h2 class="text-center mb-4">SWOT Report List</h2>

        <!-- Enhanced Filter Section -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="bi bi-funnel"></i> Filters & Controls
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <!-- Action Buttons -->
                    <div class="col-md-4">
                        <div class="d-flex flex-wrap gap-2">
                            {% if permissions.swot_report_create %}
                                <a href="{% url 'create_swot_report' %}"
                                   class="btn btn-primary"
                                   hx-get="{% url 'create_swot_report' %}"
                                   hx-target="#full-page-container"
                                   hx-swap="innerHTML"
                                   hx-push-url="true">
                                    <i class="bi bi-plus-circle"></i> Create SWOT
                                </a>
                            {% endif %}

                            <a href="{% url 'swot_report_export_to_excel' %}?export=excel&search={{ search_query }}&cycle={{ selected_cycle }}"
                               class="btn btn-success">
                                <i class="bi bi-file-earmark-excel"></i> Export Excel
                            </a>
                        </div>
                    </div>

                    <!-- Cycle Filter -->
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Strategic Cycle</label>
                        <form method="get"
                              hx-get="{% url 'swot_report_list' %}"
                              hx-target="#full-page-container"
                              hx-include="this"
                              hx-trigger="change">
                            <select name="cycle" class="form-select">
                                <option value="">All Strategic Cycles</option>
                                {% for cycle in strategic_cycles %}
                                    <option value="{{ cycle.slug }}"
                                            {% if cycle.slug == selected_cycle %}selected{% endif %}>
                                        {{ cycle.name }} ({{ cycle.time_horizon }})
                                    </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    <!-- Search Box -->
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Search</label>
                        <form method="get"
                              hx-get="{% url 'swot_report_list' %}"
                              hx-target="#full-page-container"
                              hx-include="this"
                              hx-trigger="keyup changed delay:500ms from:input[name='search']">
                            <div class="input-group">
                                <input type="text"
                                       name="search"
                                       class="form-control"
                                       placeholder="Search SWOT entries..."
                                       value="{{ search_query|default_if_none:'' }}"
                                       aria-label="Search">
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Clear & Status Filters -->
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Actions</label>
                        <div class="d-flex gap-2">
                            {% if selected_cycle or search_query %}
                                <a href="{% url 'swot_report_list' %}"
                                   class="btn btn-outline-danger flex-fill"
                                   hx-get="{% url 'swot_report_list' %}"
                                   hx-target="#full-page-container"
                                   hx-swap="innerHTML"
                                   title="Clear all filters">
                                    <i class="bi bi-x-circle"></i> Clear
                                </a>
                            {% else %}
                                <button class="btn btn-outline-secondary flex-fill" disabled>
                                    <i class="bi bi-funnel"></i> No Filters
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Active Filters Display -->
                {% if selected_cycle or search_query %}
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info py-2 mb-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="me-2">Active Filters:</strong>
                                    {% if selected_cycle %}
                                        <span class="badge bg-primary me-2">
                                            <i class="bi bi-calendar-event me-1"></i>
                                            {% for cycle in strategic_cycles %}
                                                {% if cycle.slug == selected_cycle %}
                                                    {{ cycle.name }}
                                                {% endif %}
                                            {% endfor %}
                                        </span>
                                    {% endif %}
                                    {% if search_query %}
                                        <span class="badge bg-secondary me-2">
                                            <i class="bi bi-search me-1"></i>
                                            Search: "{{ search_query }}"
                                        </span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">
                                    {{ page_obj.paginator.count }} result{{ page_obj.paginator.count|pluralize }} found
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- SWOT Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm align-middle">
                <thead class="table-light sticky-top">
                    <tr>
                        <th>#</th>
                        <th>Strategic Cycle</th>
                        <th>SWOT Type</th>
                        <th>Pillar</th>
                        <th>Factor</th>
                        <th>Description</th>
                        <th>Priority</th>
                        <th>Impact</th>
                        <th>Likelihood</th>
                        <th>Created</th>
                        <th>Updated</th>
                        {% if permissions.swot_report_edit or permissions.swot_report_delete %}
                            <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for s in page_obj %}
                        <tr>
                            <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                            <td class="text-nowrap">
                                <small>
                                    {{ s.strategic_report_period.name }}
                                </small>
                            </td>
                            <td>
                                <span class="badge
                                    {% if s.swot_type == 'Strength' %}bg-success text-white
                                    {% elif s.swot_type == 'Weakness' %}bg-danger text-white
                                    {% elif s.swot_type == 'Opportunity' %}bg-warning text-dark
                                    {% elif s.swot_type == 'Threat' %}bg-dark text-white
                                    {% else %}bg-info text-dark{% endif %}">
                                    {{ s.swot_type }}
                                </span>
                            </td>
                            <td>{{ s.swot_pillar }}</td>
                            <td>{{ s.swot_factor }}</td>
                            <td>{% if s.description %}<span title="{{ s.description }}">{{ s.description|truncatewords:12 }}</span>{% else %}<span class="text-muted">—</span>{% endif %}</td>
                            <td>
                                <span class="badge
                                    {% if s.priority == 'Very High' %}bg-danger text-white
                                    {% elif s.priority == 'High' %}bg-warning text-dark
                                    {% elif s.priority == 'Medium' %}bg-primary text-white
                                    {% elif s.priority == 'Low' %}bg-success text-white
                                    {% else %}bg-info text-dark{% endif %}">
                                    {{ s.priority }}
                                </span>
                            </td>
                            <td>
                                <span class="badge
                                    {% if s.impact == 'Very High' %}bg-danger text-white
                                    {% elif s.impact == 'High' %}bg-warning text-dark
                                    {% elif s.impact == 'Medium' %}bg-primary text-white
                                    {% elif s.impact == 'Low' %}bg-success text-white
                                    {% else %}bg-info text-dark{% endif %}">
                                    {{ s.impact }}
                                </span>
                            </td>
                            <td>
                                {% if s.likelihood %}
                                    <span class="badge
                                        {% if s.likelihood == 'Almost Certain' %}bg-danger text-white
                                        {% elif s.likelihood == 'Likely' %}bg-warning text-dark
                                        {% elif s.likelihood == 'Possible' %}bg-primary text-white
                                        {% elif s.likelihood == 'Unlikely' %}bg-success text-white
                                        {% elif s.likelihood == 'Rare' %}bg-info text-dark
                                        {% else %}bg-secondary text-white{% endif %}">
                                        {{ s.likelihood }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="text-nowrap"><small>{{ s.created_at|date:"M d, Y" }}</small></td>
                            <td class="text-nowrap"><small>{{ s.updated_at|date:"M d, Y" }}</small></td>
                            {% if permissions.swot_report_edit or permissions.swot_report_delete %}
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if permissions.swot_report_edit %}
                                            <a class="btn btn-outline-warning"
                                               hx-get="{% url 'update_swot_report' s.pk %}"
                                               hx-target="#full-page-container"
                                               hx-swap="innerHTML"
                                               hx-push-url="true"
                                               title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        {% endif %}
                                        {% if permissions.swot_report_delete %}
                                            <a class="btn btn-outline-danger"
                                               hx-get="{% url 'delete_swot_report' s.pk %}"
                                               hx-target="#full-page-container"
                                               hx-swap="innerHTML"
                                               hx-push-url="true"
                                               title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            {% endif %}
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="{% if permissions.swot_report_edit or permissions.swot_report_delete %}12{% else %}11{% endif %}" class="text-center py-4">
                                {% if selected_cycle or search_query %}
                                    <div class="text-muted">
                                        <i class="bi bi-search display-4"></i>
                                        <h5>No SWOT entries found</h5>
                                        <p>No results match your current filters.</p>
                                        <a href="{% url 'swot_report_list' %}"
                                           hx-get="{% url 'swot_report_list' %}"
                                           hx-target="#full-page-container"
                                           hx-swap="innerHTML"
                                           class="btn btn-primary">Clear filters</a>
                                    </div>
                                {% else %}
                                    <div class="text-muted">
                                        <i class="bi bi-clipboard display-4"></i>
                                        <h5>No SWOT entries yet</h5>
                                        <p>Get started by creating your first SWOT analysis.</p>
                                        {% if permissions.swot_report_create %}
                                            <a href="{% url 'create_swot_report' %}"
                                               hx-get="{% url 'create_swot_report' %}"
                                               hx-target="#full-page-container"
                                               hx-swap="innerHTML"
                                               hx-push-url="true"
                                               class="btn btn-primary">Create your first SWOT report</a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="card-footer mt-3">
            <div id="pagination">{% include 'pagination.html' %}</div>
        </div>

        <!-- Results Count -->
        <div class="mt-2 text-muted">
            Showing {{ page_obj|length }} of {{ page_obj.paginator.count }} SWOT report{{ page_obj.paginator.count|pluralize }}
        </div>

    {% else %}
        <!-- No Permission Message -->
        <div class="alert alert-danger text-center">
            <i class="bi bi-shield-exclamation me-2"></i>
            You don't have permission to view SWOT reports.
        </div>
    {% endif %}

</div>

<style>
    .badge { font-size: 0.8em; padding: 0.45em 0.65em; }
    .table td { vertical-align: middle; }
    .btn-group { white-space: nowrap; }
    thead.sticky-top th { background: #f8f9fa; z-index: 2; }
    .card-header { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
</style>
{% endblock content %}