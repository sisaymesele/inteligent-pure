{% extends "dashboard.html" %}
{% load humanize %}
{% block content %}

<!-- Header: Back Left, Title Center, Responsive -->
<div class="d-flex flex-column flex-md-row align-items-center justify-content-center position-relative mb-3">
    <!-- Back Button: left-aligned on all screens -->
    <div class="position-absolute start-0 top-50 translate-middle-y">
        <a class="btn btn-danger btn-sm"
           hx-get="{% url 'strategic_action_plan_by_cycle' %}"
           hx-target="#full-page-container"
           hx-swap="innerHTML"
           hx-push-url="true">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>

    <!-- Title: centered -->
    <div class="text-center w-100">
        <h2 class="mb-0 fs-5 fs-md-4">Risk Management Records</h2>
        <h5 class="text-muted mb-0 fs-6 fs-md-5">Organization: {{ request.user.organization_name }}</h5>
    </div>
</div>

<!-- Header Line 2: Search + Filter + Buttons -->
<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-2">
    <!-- Search -->
    <div class="flex-grow-1 me-2">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" name="search" class="form-control"
                   placeholder="Search by category, name, or mitigation action"
                   value="{{ search_query|default_if_none:'' }}"
                   hx-get="{% url 'risk_management_list' %}"
                   hx-target="#full-page-container"
                   hx-trigger="keyup changed delay:500ms">
        </div>
    </div>

    <!-- Filter: Strategic Cycle -->
    <div class="me-2">
        <select name="strategic_cycle" class="form-select"
                hx-get="{% url 'risk_management_list' %}"
                hx-target="#full-page-container"
                hx-swap="innerHTML"
                hx-trigger="change">
            <option value="">--- All Strategic Cycles ---</option>
            {% for cycle in cycle_choices %}
                <option value="{{ cycle.id }}" {% if selected_cycle == cycle.id|stringformat:"s" %}selected{% endif %}>
                    {{ cycle.name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <a class="btn btn-secondary"
       hx-get="{% url 'risk_management_list' %}"
       hx-target="#full-page-container"
       hx-swap="innerHTML"
       hx-push-url="true">
        Reset
    </a>

    <!-- Buttons - Only check create permission for Add button -->
    <div class="d-flex gap-2 flex-wrap">
        <!-- Export always visible if user can view the list -->
        <a class="btn btn-success"
           href="{% url 'export_risk_management_excel' %}?search={{ search_query }}&strategic_cycle={{ selected_cycle }}">
            <i class="bi bi-file-earmark-excel"></i> Export
        </a>

        <!-- Add Risk Button - Only check create permission -->
        {% if permissions.risk_management_create %}
        <a class="btn btn-primary"
           hx-get="{% url 'create_risk_management' %}"
           hx-target="#full-page-container"
           hx-swap="innerHTML"
           hx-push-url="true">
            <i class="bi bi-plus-circle"></i> Add Risk
        </a>
        {% endif %}
    </div>
</div>

<!-- Table Section -->
<div id="full-page-container">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Risks</h5>
            <span class="badge bg-primary">{{ page_obj.paginator.count }} records</span>
        </div>

        <div class="table-responsive" style="max-height:70vh; overflow:auto;">
            <table class="table table-bordered table-hover table-sm align-middle">
                <thead class="table-dark sticky-top text-center">
                    <tr>
                        <th>#</th>
                        <th>Category</th>
                        <th>Name</th>
                        <th>Mitigation</th>
                        <th>Likelihood</th>
                        <th>Impact</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Strategic Cycle</th>
                        <th>Created</th>
                        <th>Updated</th>
                        <!-- Actions column - only show if user has edit permission -->
                        {% if permissions.risk_management_edit or permissions.risk_management_delete %}
                        <th class="text-center">Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for risk in page_obj %}
                    <tr>
                        <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                        <td>{{ risk.risk_category }}</td>
                        <td>{{ risk.risk_name }}</td>
                        <td>{{ risk.mitigation_action|default:"—" }}</td>
                        <td class="text-capitalize">{{ risk.get_likelihood_display }}</td>
                        <td class="text-capitalize">{{ risk.get_impact_display }}</td>
                        <td class="fw-bold text-center">{{ risk.severity_score }}</td>
                        <td class="text-center">
                            {% if risk.status == 'identified' %}
                                <span class="badge bg-warning text-dark">Identified</span>
                            {% elif risk.status == 'mitigated' %}
                                <span class="badge bg-info text-dark">Mitigated</span>
                            {% elif risk.status == 'closed' %}
                                <span class="badge bg-success">Closed</span>
                            {% else %}
                                <span class="badge bg-secondary">Unknown</span>
                            {% endif %}
                        </td>
                        <td>{{ risk.strategic_cycle.name|default:"—" }}</td>
                        <td>{{ risk.created_at|date:"F d, Y" }}</td>
                        <td>{{ risk.updated_at|date:"F d, Y" }}</td>

                        <!-- Actions column -->
                        {% if permissions.risk_management_edit or permissions.risk_management_delete %}
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <!-- Edit Button - Only check edit permission -->
                                {% if permissions.risk_management_edit %}
                                <a class="btn btn-warning"
                                   hx-get="{% url 'update_risk_management' risk.pk %}"
                                   hx-target="#full-page-container"
                                   hx-swap="innerHTML"
                                   hx-push-url="true"
                                   title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                {% endif %}

                                <!-- Delete Button - Only check delete permission -->
                                {% if permissions.risk_management_delete %}
                                <a class="btn btn-danger"
                                   hx-get="{% url 'delete_risk_management' risk.pk %}"
                                   hx-target="#full-page-container"
                                   hx-swap="innerHTML"
                                   hx-push-url="true"
                                   title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if permissions.risk_management_edit or permissions.risk_management_delete %}12{% else %}11{% endif %}"
                            class="text-center py-4 text-muted">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                            <p class="mt-2">No Risk Management entries found.</p>

                            <!-- Only show "Add first risk" button if user has create permission -->
                            {% if permissions.risk_management_create %}
                            <a class="btn btn-primary mt-2"
                               hx-get="{% url 'create_risk_management' %}"
                               hx-target="#full-page-container"
                               hx-swap="innerHTML"
                               hx-push-url="true">
                                Add your first risk
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="card-footer">
            <div id="pagination">
                {% include 'pagination.html' %}
            </div>
        </div>
    </div>
</div>

<style>
.sticky-top { position: sticky; top: 0; z-index: 10; }
.table th { white-space: nowrap; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltips.map(function(el) { return new bootstrap.Tooltip(el) })
})
</script>

{% endblock %}